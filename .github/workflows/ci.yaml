name: CI Pipeline for All Services with Docker Compose + ArgoCD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set environment variables for all services
        run: |
          cat <<EOF > .env
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}
          DEMO_VERSION=${{ github.run_id }}
          IMAGE_VERSION=latest
          ACCOUNTING_DOCKERFILE=src/accounting/Dockerfile
          AD_DOCKERFILE=src/ad/Dockerfile
          CART_DOCKERFILE=src/cart/src/Dockerfile
          CHE
name: CI Pipeline for All Services with Docker Compose + ArgoCD

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set environment variables for all services
        run: |
          cat <<EOF > .env
          IMAGE_NAME=${{ secrets.DOCKER_USERNAME }}
          DEMO_VERSION=${{ github.run_id }}
          IMAGE_VERSION=latest
          ACCOUNTING_DOCKERFILE=src/accounting/Dockerfile
          AD_DOCKERFILE=src/ad/Dockerfile
          CART_DOCKERFILE=src/cart/src/Dockerfile
          CHECKOUT_DOCKERFILE=src/checkout/Dockerfile
          CURRENCY_DOCKERFILE=src/currency/Dockerfile
          EMAIL_DOCKERFILE=src/email/Dockerfile
          FLAGD_DOCKERFILE=src/flagd/Dockerfile
          FLAGD_UI_DOCKERFILE=src/flagd-ui/Dockerfile
          FRAUD_DOCKERFILE=src/fraud-detection/Dockerfile
          FRONTEND_DOCKERFILE=src/frontend/Dockerfile
          FRONTEND_PROXY_DOCKERFILE=src/frontend-proxy/Dockerfile
          IMAGE_PROVIDER_DOCKERFILE=src/image-provider/Dockerfile
          KAFKA_DOCKERFILE=src/kafka/Dockerfile
          LOAD_GENERATOR_DOCKERFILE=src/load-generator/Dockerfile
          OTEL_COLLECTOR_DOCKERFILE=src/otel-collector/Dockerfile
          PAYMENT_DOCKERFILE=src/payment/Dockerfile
          PRODUCT_CATALOG_DOCKERFILE=src/product-catalog/Dockerfile
          QUOTE_DOCKERFILE=src/quote/Dockerfile
          REACT_NATIVE_APP_DOCKERFILE=src/react-native-app/Dockerfile
          RECOMMENDATION_DOCKERFILE=src/recommendation/Dockerfile
          SHIPPING_DOCKERFILE=src/shipping/Dockerfile
          EOF

      - name: Debug – Check Dockerfile paths
        run: |
          echo "🔍 Listing Dockerfiles referenced in .env"
          grep DOCKERFILE .env | while IFS='=' read -r key path; do
            echo "Checking $key -> $path"
            if [ -f "$path" ]; then
              echo "✅ Found: $path"
            else
              echo "❌ Missing: $path"
            fi
          done

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and Push All Microservices via Docker Compose
        run: |
          docker-compose --env-file .env build
          for svc in $(docker-compose --env-file .env config --services); do
            image="${{ secrets.DOCKER_USERNAME }}/${svc}:${{ github.run_id }}"
            echo "🚀 Pushing $svc -> $image"
            docker tag $svc $image
            docker push $image
          done

      - name: Update Kubernetes Manifest File
        run: |
          for sv
