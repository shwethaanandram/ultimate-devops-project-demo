name: CI Pipeline for All Services with Docker Compose + ArgoCD

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env file
        run: |
          cat <<EOF > .env
          IMAGE_VERSION=1.12.0
          IMAGE_NAME=ghcr.io/open-telemetry/demo
          DEMO_VERSION=latest
          TRACETEST_IMAGE_VERSION=v1.7.1
          OTEL_JAVA_AGENT_VERSION=2.10.0
          OPENTELEMETRY_CPP_VERSION=1.18.0
          COLLECTOR_CONTRIB_IMAGE=ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib:0.116.1
          FLAGD_IMAGE=ghcr.io/open-feature/flagd:v0.11.5
          GRAFANA_IMAGE=grafana/grafana:11.4.0
          JAEGERTRACING_IMAGE=jaegertracing/all-in-one:1.64.0
          OPENSEARCH_IMAGE=opensearchproject/opensearch:2.18.0
          POSTGRES_IMAGE=postgres:17.2
          PROMETHEUS_IMAGE=quay.io/prometheus/prometheus:v3.0.1
          VALKEY_IMAGE=valkey/valkey:8.0-alpine
          TRACETEST_IMAGE=kubeshop/tracetest:v1.7.1
          ENV_PLATFORM=local
          HOST_FILESYSTEM=/
          DOCKER_SOCK=/var/run/docker.sock
          OTEL_COLLECTOR_HOST=otel-collector
          OTEL_COLLECTOR_PORT_GRPC=4317
          OTEL_COLLECTOR_PORT_HTTP=4318
          OTEL_COLLECTOR_CONFIG=./src/otel-collector/otelcol-config.yml
          OTEL_COLLECTOR_CONFIG_EXTRAS=./src/otel-collector/otelcol-config-extras.yml
          OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
          PUBLIC_OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://localhost:8080/otlp-http/v1/traces
          OTEL_RESOURCE_ATTRIBUTES=service.namespace=opentelemetry-demo,service.version=1.12.0
          OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE=cumulative
          # Add any others if needed
          EOF

      - name: Build all services
        run: docker compose --env-file .env build --parallel

